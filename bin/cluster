#!/usr/bin/env node
var cluster = require('cluster');
var mq = require('strong-mq');
var io = require('socket.io');
var ClusterStore = require('strong-cluster-socket.io-store')(io);
var WorkerServer = require('../lib/worker');

var port = process.argv[2];

var connection = mq.create({
  provider: 'native'
});

if (cluster.isMaster) {
  cluster.fork();
  cluster.fork();
} else {
  var server = WorkerServer.createServer({
    port: port,
    mq: connection.open(),
    ioStore: new ClusterStore()
  });

  server.start(function (err) {
    if (err) {
      console.error('Worker ' + process.pid + ' failed to start with:', err.message || err);
      process.exit(1);
    }

    console.log('Worker ' + process.pid + ' listening on port ' + server.port + '...');
  });
}
