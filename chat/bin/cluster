#!/usr/bin/env node
var cluster = require('cluster');
var mq = require('strong-mq');
var WorkerServer = require('../lib/worker');

var port = process.argv[2] || 1337;
var connection = mq.create({
  provider: 'native'
});

if (cluster.isMaster) {
  cluster.fork({
    PORT: Number(port)
  });
  cluster.fork({
    PORT: Number(port) + 1
  });
} else {
  var server = WorkerServer.createServer({
    mq: connection.open()
  });

  server.start(function (err) {
    if (err) {
      console.error('Worker ' + process.pid + ' failed to start with:', err.message || err);
      process.exit(1);
    }

    console.log('Worker ' + process.pid + ' listening on port ' + server.port + '...');
  });
}
